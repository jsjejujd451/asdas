<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build File Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #007bff;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }
        input[type="file"], select, button {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px; /* Touch-friendly */
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px; /* Larger for mobile */
            min-height: 50px; /* Touch target */
        }
        button:hover {
            background-color: #0056b3;
        }
        button:active {
            background-color: #004494; /* Press effect */
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #output {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            font-size: 12px; /* Smaller font for code on mobile */
        }
        .error {
            color: red;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .success {
            color: green;
            background: #e6ffe6;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 20% auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .ad-btn {
            background-color: #28a745;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 16px;
            min-height: 50px; /* Touch-friendly */
            width: 100%;
        }
        .ad-btn:hover {
            background-color: #218838;
        }
        .ad-btn:active {
            background-color: #1e7e34;
        }
        /* Mobile Responsive */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 24px;
            }
            input[type="file"], select, button {
                padding: 12px;
                font-size: 16px; /* iOS zoom prevention */
            }
            #output {
                font-size: 11px;
                max-height: 200px;
            }
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <h1>Build File Converter (.build ‚Üî .Build)</h1>
    <div class="container">
        <label for="inputFile">Upload Input File:</label>
        <input type="file" id="inputFile" accept=".build,.Build,.json">

        <label for="direction">Conversion Direction:</label>
        <select id="direction">
            <option value="build_to_Build">.build ‚Üí .Build</option>
            <option value="Build_to_build">.Build ‚Üí .build</option>
        </select>

        <label for="outputFileName">Output File Name (without extension):</label>
        <input type="text" id="outputFileName" value="converted" placeholder="e.g., converted">

        <button id="convertBtn" onclick="showAdModal()">Convert</button>

        <div id="output"></div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success"></div>
    </div>

    <!-- Ad Modal -->
    <div id="adModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="openLinkAndClose()">&times;</span>
            <h2>–ü–æ–¥–¥–µ—Ä–∂–∏ –ø—Ä–æ–µ–∫—Ç! üòä</h2>
            <p>–ü–µ—Ä–µ–¥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –∑–∞–≥–ª—è–Ω–∏ –≤ –∫—Ä—É—Ç–æ–π Telegram-–±–æ—Ç –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞: <a href="https://t.me/ldidia_bot?start=refypfDJWY" target="_blank">@ldidia_bot</a></p>
            
            <button class="ad-btn" onclick="closeAdModalAndConvert()">–ü–æ–Ω—è–ª, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å!</button>
        </div>
    </div>

    <script>
        let convertAfterAd = false;

        function showAdModal() {
            document.getElementById('adModal').style.display = 'block';
        }

        function closeAdModal() {
            document.getElementById('adModal').style.display = 'none';
        }

        function openLinkAndClose() {
            window.open('https://t.me/ldidia_bot?start=refypfDJWY', '_blank');
            closeAdModal();
        }

        function closeAdModalAndConvert() {
            closeAdModal();
            convertFiles();
        }

        // Close modal if clicked outside
        window.onclick = function(event) {
            const modal = document.getElementById('adModal');
            if (event.target == modal) {
                openLinkAndClose();
            }
        }

        // Math functions for rotations (Euler XYZ to/from Matrix)
        function crossProduct(a, b) {
            return [
                a[1] * b[2] - a[2] * b[1],
                a[2] * b[0] - a[0] * b[2],
                a[0] * b[1] - a[1] * b[0]
            ];
        }

        function matrixFromEuler(euler) { // euler [x,y,z] in degrees, XYZ order
            const rad = euler.map(deg => deg * Math.PI / 180);
            const cx = Math.cos(rad[0]), sx = Math.sin(rad[0]);
            const cy = Math.cos(rad[1]), sy = Math.sin(rad[1]);
            const cz = Math.cos(rad[2]), sz = Math.sin(rad[2]);

            // Rotation matrix for XYZ Euler
            return [
                [cy * cz, -cy * sz, sy],
                [cx * sz + sx * sy * cz, cx * cz - sx * sy * sz, -sx * cy],
                [sx * sz - cx * sy * cz, sx * cz + cx * sy * sz, cx * cy]
            ];
        }

        function eulerFromMatrix(matrix) {
            // Approximate Euler XYZ from matrix (degrees)
            const sy = Math.sqrt(matrix[0][0] * matrix[0][0] + matrix[1][0] * matrix[1][0]);
            if (sy < 1e-6) {
                const x = Math.atan2(-matrix[2][1], matrix[2][2]) * 180 / Math.PI;
                const y = Math.atan2(matrix[1][0], matrix[0][0]) * 180 / Math.PI;
                const z = 0;
                return [x, y, z];
            } else {
                const x = Math.atan2(matrix[2][1], matrix[2][2]) * 180 / Math.PI;
                const y = Math.atan2(sy, matrix[2][0]) * 180 / Math.PI;
                const z = Math.atan2(matrix[1][0], -matrix[0][0]) * 180 / Math.PI;
                return [x, y, z];
            }
        }

        function convertBuildToBuild(data) {
            // .build (array of arrays) to .Build (dict of lists)
            const buildDict = {};
            data.forEach(entry => {
                if (!Array.isArray(entry) || entry.length < 6) {
                    console.warn('Invalid entry:', entry);
                    return;
                }
                const typ = entry[0];
                if (!buildDict[typ]) buildDict[typ] = [];

                const pos = entry[1];
                const right = entry[2];
                const up = entry[3];
                const sizeArr = entry[4];
                const anchored = entry[5];

                // Compute Z = cross(right, up)
                const z = crossProduct(right, up);

                // Matrix columns: right, up, z (transposed for rows)
                const matrix = [
                    [right[0], up[0], z[0]],
                    [right[1], up[1], z[1]],
                    [right[2], up[2], z[2]]
                ];

                // Euler XYZ degrees
                const euler = eulerFromMatrix(matrix);
                const rotStr = euler.map(e => e.toFixed(5)).join(',');

                // Position and Size strings
                const posStr = Array.isArray(pos) ? pos.join(',') : pos;
                let sz = Array.isArray(sizeArr) ? sizeArr[2] : sizeArr;
                if (Math.abs(sz) < 1e-10) sz = 0.2;
                const sizeStr = (Array.isArray(sizeArr) ? [sizeArr[0], sizeArr[1], sz] : [sizeArr, sizeArr, sz]).join(',');

                const part = {
                    "Rotation": rotStr,
                    "Transparency": 0,
                    "ShowShadow": true,
                    "Position": posStr,
                    "Anchored": anchored,
                    "CanCollide": true,
                    "Size": sizeStr
                };
                buildDict[typ].push(part);
            });
            return buildDict;
        }

        function convertBuildToBuildRev(data) {
            // .Build (dict) to .build (array of arrays)
            const buildList = [];
            Object.entries(data).forEach(([typ, parts]) => {
                if (!Array.isArray(parts)) return;
                parts.forEach(part => {
                    if (typeof part !== 'object' || !part.Position || !part.Size || !part.Rotation) {
                        console.warn('Invalid part:', part);
                        return;
                    }
                    // Parse Position, Size, Rotation
                    const pos = part.Position.split(',').map(Number);
                    const size = part.Size.split(',').map(Number);
                    const euler = part.Rotation.split(',').map(Number);

                    // Matrix from Euler XYZ
                    const matrix = matrixFromEuler(euler);

                    // Vectors: right (col0), up (col1)
                    const right = [matrix[0][0], matrix[1][0], matrix[2][0]];
                    const up = [matrix[0][1], matrix[1][1], matrix[2][1]];

                    const anchored = part.Anchored !== undefined ? part.Anchored : true;
                    const color = [1, 1, 1]; // Default

                    const entry = [typ, pos, right, up, size, anchored, color];
                    buildList.push(entry);
                });
            });
            return buildList;
        }

        function downloadJSON(data, filename, extension) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + extension;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function convertFiles() {
            const inputFile = document.getElementById('inputFile').files[0];
            const direction = document.getElementById('direction').value;
            const outputName = document.getElementById('outputFileName').value || 'converted';
            const outputDiv = document.getElementById('output');
            const errorDiv = document.getElementById('error');
            const successDiv = document.getElementById('success');

            outputDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            if (!inputFile) {
                alert('Please select a file!');
                return;
            }

            const extension = direction === 'build_to_Build' ? '.Build' : '.build';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    let converted;

                    if (direction === 'build_to_Build') {
                        converted = convertBuildToBuild(data);
                    } else {
                        converted = convertBuildToBuildRev(data);
                    }

                    // Show output preview
                    outputDiv.textContent = JSON.stringify(converted, null, 2);
                    outputDiv.style.display = 'block';

                    // Download with correct extension
                    downloadJSON(converted, outputName, extension);

                    // Show success message
                    successDiv.textContent = '‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –§–∞–π–ª —Å–∫–∞—á–∞–Ω –∫–∞–∫ ' + outputName + extension;
                    successDiv.style.display = 'block';
                } catch (err) {
                    console.error(err);
                    errorDiv.textContent = '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–∞–π–ª–∞: ' + err.message + '. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ñ–∞–π–ª ‚Äî –≤–∞–ª–∏–¥–Ω—ã–π JSON –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É (.build –∏–ª–∏ .Build).';
                    errorDiv.style.display = 'block';
                }
            };
            reader.readAsText(inputFile);
        }
    </script>
</body>

</html>
